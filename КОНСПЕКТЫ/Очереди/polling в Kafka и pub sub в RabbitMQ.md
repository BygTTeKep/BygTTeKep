Apache Kafka - распределеный прогграмный брокер
Цель ее является горизонтальное масштабирование для потоковой обработки данных в реал лайф с высокой пропускной способностью и низкой задержкой
данные на диске физически хранятся в виде сегментов
сегмент состоит из 3-ех типов файлов
1) .log - хранит сами данные ограничен в 1 гб
2) .index - содержит маппинг offset на позицию в файле, offset - смещение в сегменте, а position - смещение в .log
3) .timeindex - временой индекс мапит timestamp - offset
Есть валидация на timestamp чтобы нельзя было записать в будущее KIP-937

KAFKA Producer
как работает
1) метод send(отправляем сообщение)
2) fetch metadata(сбор методаных топологии даных)
3) serializer(сериализация сообщения)
4) partitioner(выбор нуной партиции)
5) batch accumulator(пакетная оработка)
6) sender(отправка в сеть)
BATCH ACCUMULATOR
![[Pasted image 20251005104256.png]]
Компрессия для пачки данных

KAFKA CONSUMER
Используется pull model, тоесть консюмер сам запрашивает данные, после получения данных консюмер делает комит
consumer group
для координации груп использует group координатор
сами данных по комитам сохраняются в системный топик consumer_offsets(сохраняется groupid, topic, partition, offset)

Репликация
данные и пишутся и читаются с лидер брокера, у лидера есть несколько реплик(фоловеры)
ISR(IN SYNK REPLICS) - список реплик которые находятся в синзронизации с лидером, это значит что эти реплики отсают от лидера на время которое не превышает определеное пороговое значение, если вермя превышае то такая реплика исплчается из списка ISR
min.insync.replicas - минимальное количество реплик которые находятся в синхронизации с лидером
acks - способ подтверждения сообщения
acks = 0 - отправили и забыли, не ждем подтверждения даже от лидера
acks = 1 - ждем подтверждения от лидер брокера
acks = -1(all) ждем подтвердждения от всех реплик в списке isr
![[Pasted image 20251005105320.png]]
Настройка производительности producer
- batch.size
- linger.ms
- compression.type
- max.in.flight.request.per.connection
- acks

RMQ
Это програмный брокер который реализует протокол amqp
amqp - Это протокол предназначеный для обмена сообениями между распределенными сообщениями
Архитектура
Producer - concumer

слой exchange - маршрутизации разных типов

слой bindings

очереди бывают разных типов 

QUEUE - сама очередь сообщений
exchange - компонент, который получает сообщения от отправителей и направляет из в соответствющие очереди в зависимости от заданных правил маршрутизации

bindings - правило которое определяет, как exchange должен направлять сообщения в очереди на основе routing key

routing key - атрибут сообщения, который используется для определения его маршрута.

rmq server internals
![[Pasted image 20251005111444.png]]
reader - принимает запрос от клиентов
framing - работа с фреймами(кодирование декодирование)
writer - отправка сообщений 
chanel - виртуальнй канал для изоляции операций
mnesia - конфигурационная бд, хранит всю конфигурацию брокера

тип обмена 
fanout  - широковещательная рассылка(без ключей маршрутизации), рассылает сообщения на все очереди
direct - точое соответствие ключам(маршрутизация по ключу)
headers exchange - атрибуты заголовка(маршрутизация по атрибутам)
topic - шаблоны ключей (метасимволы) 

типы очередей
Кворумные очереди(обеспечивают надежность за счет репликации данныхв)
потоковые очереди(предназначены для большиз объемов данных и высокой пропускнйо способности)
класические очереди

Кворумные очереди 
![[Pasted image 20251005112358.png]]
свойства очередей
1) durable(опеределяет будет ли сохранятся очередь после перезагрузки брокера)
2) auto delete(определяет будет ли удалена очередь после отлючения потребителя от нее)
3) exclusive(Если очередь объявлена как exclusive то она доступна только для одного соединения)
4) ttl(время нахождения сообщения в очереди)

![[Pasted image 20251005113530.png]]